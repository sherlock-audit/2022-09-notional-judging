xiaoming90

medium

# Corruptible Upgradability Pattern

## Summary

Storage of Boosted3TokenAuraVault and MetaStable2TokenAuraVault vaults might be corrupted during an upgrade.

## Vulnerability Detail

Following are the inheritance of the Boosted3TokenAuraVault and MetaStable2TokenAuraVault vaults.

```solidity
Boosted3TokenAuraVault -> Boosted3TokenPoolMixin -> PoolMixin -> BalancerStrategyBase -> [BaseStrategyVault, UUPSUpgradeable]
                                                              -> AuraStakingMixin
```

```solidity
MetaStable2TokenAuraVault -> MetaStable2TokenVaultMixin -> TwoTokenPoolMixin -> PoolMixin -> BalancerStrategyBase -> [BaseStrategyVault, UUPSUpgradeable]
                                                        -> BalancerOracleMixin
```

The Boosted3TokenAuraVault and MetaStable2TokenAuraVault vaults are meant to be upgradable, but it inherits contracts that are not upgrade-safe. 

The gap storage has been implemented on the `BaseStrategyVault` and `BalancerStrategyBase` contracts inherited by the Boosted3TokenAuraVault and MetaStable2TokenAuraVault vaults.

https://github.com/sherlock-audit/2022-09-notional/blob/main/leveraged-vaults/contracts/vaults/BaseStrategyVault.sol#L14

```solidity
abstract contract BaseStrategyVault is Initializable, IStrategyVault {
    using TokenUtils for IERC20;
    using TradeHandler for Trade;
    ..SNIP..
    // Storage gap for future potential upgrades
    uint256[45] private __gap;
}
```

https://github.com/sherlock-audit/2022-09-notional/blob/main/leveraged-vaults/contracts/vaults/balancer/BalancerStrategyBase.sol#L9

```solidity
abstract contract BalancerStrategyBase is BaseStrategyVault, UUPSUpgradeable {
    /** Immutables */
    uint32 internal immutable SETTLEMENT_PERIOD_IN_SECONDS;
    ..SNIP..
    // Storage gap for future potential upgrades
    uint256[100] private __gap;
}
```

However, no gap storage is implemented on the `Boosted3TokenPoolMixin`, `MetaStable2TokenVaultMixin`, `TwoTokenPoolMixin`, and `PoolMixin` contracts inherited by the Boosted3TokenAuraVault and MetaStable2TokenAuraVault vaults. Thus, adding new storage variables to these inherited contracts will overwrite storage slots that have already been assigned to the proxy contract.

## Impact

Storage of Boosted3TokenAuraVault and MetaStable2TokenAuraVault vaults might be corrupted during upgrading, thus causing the vaults to be broken and assets to be stuck.

## Code Snippet

https://github.com/sherlock-audit/2022-09-notional/blob/main/leveraged-vaults/contracts/vaults/BaseStrategyVault.sol#L14
https://github.com/sherlock-audit/2022-09-notional/blob/main/leveraged-vaults/contracts/vaults/balancer/BalancerStrategyBase.sol#L9

## Tool used

Manual Review

## Recommendation

Consider adding an appropriate storage gap at the end of inherited contracts (`Boosted3TokenPoolMixin`, `MetaStable2TokenVaultMixin`, `TwoTokenPoolMixin`, and `PoolMixin`)